/**
 * 값의 타입을 판별하는 함수
 * @param {*} value - 확인할 값
 * @returns {string} - 값의 타입 ('undefined', 'array', 'object', 'scalar')
 */
function valueType (value) {
  if (value === undefined) return 'undefined'
  if (Array.isArray(value)) return 'array'
  if (typeof value === 'object') return 'object'
  return 'scalar'
}

/**
 * 마지막 값 설정하는 함수
 * @param {Object} context - 현재 컨텍스트
 * @param {Object} step - 다음 단계 정보
 * @param {*} currentValue - 현재 값
 * @param {*} entryValue - 입력 값
 * @returns {Object} - 수정된 컨텍스트
 */
function setLastValue (context, step, currentValue, entryValue) {
  switch (valueType(currentValue)) {
    case 'undefined':
      if (step.append) {
        context[step.key] = [entryValue]
      } else {
        context[step.key] = entryValue
      }
      break
    case 'array':
      context[step.key].push(entryValue)
      break
    case 'object':
      return setLastValue(currentValue, { type: 'object', key: '', last: true }, currentValue[''], entryValue)
    case 'scalar':
      context[step.key] = [context[step.key], entryValue]
      break
  }

  return context
}

/**
 * 값 설정하는 함수
 * @param {Object} context - 현재 컨텍스트
 * @param {Object} step - 다음 단계 정보
 * @param {*} currentValue - 현재 값
 * @param {*} entryValue - 입력 값
 * @returns {Object} - 수정된 컨텍스트
 */
function setValue (context, step, currentValue, entryValue) {
  if (step.last) return setLastValue(context, step, currentValue, entryValue)

  var obj
  switch (valueType(currentValue)) {
    case 'undefined':
      if (step.nextType === 'array') {
        context[step.key] = []
      } else {
        context[step.key] = Object.create(null)
      }
      return context[step.key]
    case 'object':
      return context[step.key]
    case 'array':
      if (step.nextType === 'array') {
        return currentValue
      }

      obj = Object.create(null)
      context[step.key] = obj
      currentValue.forEach(function (item, i) {
        if (item !== undefined) obj['' + i] = item
      })

      return obj
    case 'scalar':
      obj = Object.create(null)
      obj[''] = currentValue
      context[step.key] = obj
      return obj
  }
}

module.exports = setValue
